<html> 
	<head>
		<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.css"/>
		<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-reboot.css"/>
		<link rel="stylesheet" href="/static/bootstrap/css/bootstrap-grid.css"/>
		<script src="/static/bootstrap/js/bootstrap.js"></script>
	</head>

	<body style="background-color: #ffe6ff" >       
<nav style="background-color: #50216e; height:200px; width:100%" class="navbar navbar-expand-md mb-3">
    	<a style="margin-left:20px;"href="#">
    	<img src="/static/images/dstormlogo2.png" height="100" width="350"
    		style="background-color: white;" class="img-thumbnail" alt="Thumbnail Image"/>
    	</a>
    <div class="container">
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div style="margin: 0 auto;margin-left:10%;" class="navbar-nav">
				<div class="btn-group">
					<a style="font-color: white;font-weight:bold;" href="/" class="btn btn-secondary">
						<i class="fa fa-home"></i> Home
					</a>
    				<a style="font-color: white;font-weight:bold;" href="/upload_files" class="btn btn-secondary"> 
    					Manage experiment files 
    				</a>
    				<a style="font-color: white;font-weight:bold;" href="/runscan" class="btn btn-secondary"> 
    					Run scan 
    				</a>
                    <a style="font-color: white;font-weight:bold;" href="/runprescan" class="btn btn-secondary active"> 
                        Pre scan 
                    </a>
				</div>
			</div>
		</div>
    </div>    
</nav>

<div class="container">
<div class="row card" style="display:block;margin:0 auto; width: 1220px;">
<div id="select_files" style="display:block;margin:0 auto; width: 1120px;" >
    <div class="row mb-3 mt-3">
    <div class="input-group">
    <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon1"> Choose folder </span>
    </div>
        <select class="custom-select" onclick=search() id="folderselect">
        </select>
    </div>
    </div>
    <div class="row mb-3 mt-1">
        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text" id="basic-addon1"> Search </span>
          </div>
          <input id="search" oninput=search() type="text" class="form-control" placeholder="Enter experiment file name" aria-label="Username" aria-describedby="basic-addon1">
        </div>
    </div>

    <div class="row mb-1">
        <div class="col-lg-8">
        <div class="row">
            <div class="col-lg-6" id="first_files_text">
            </div>
            <div class="col-lg-6" id="second_files_text">
            </div>
        </div>        
        </div>
        <div class="col-lg-4">    
             <h2> Files chosen for scan: <span id="num_of_files_selected"> </span> </h2>  
            <ul class="list-group mb-2 mt-3">
            <div id="files_selected">
            </div>
          </ul>
        <br/>
        <div id="scan_options" style="visibility:hidden;">
        <div id="runscan_button">
        <div class="btn-group btn-group-sm" role="group" aria-label="First group">
            <button type="button" class="btn btn-secondary" onclick="runPrescan()">Prescan</button>
            <button type="button" class="btn btn-secondary" onclick="openConfigScanParamsModal()">Configure sample </button>
            <button type="button" class="btn btn-secondary" onclick="resetFiles()">Reset</button>
        </div>
        </div>
        <div class="row mt-3">
        <div class="col-md-5 pr-1 pt-1">
        <div class="form-check">
            <input type="checkbox" checked="true" class="form-check-input" id="genThreeD">
            <label class="form-check-label" for="a">Generate 3D plots</label>
        </div>
        </div>
        <div class="col-md-4 pl-0 pr-1">
        <div class="form-group">
        <select class="form-control form-control-sm" value="0" id="selectTheme">
            <option value="1">Regular</option>
            <option value="2">Dark</option>
            <option value="3">White</option>S
        </select>
        </div>
        </div>
        </div>
        </div>
        </div>
    </div>

    <div class="row mb-3 mt-4" style="margin: 0 auto">
        <div class="col-lg-4">
        </div>
        <div class="col-lg-4">
        <center>
        <nav aria-label="...">
        <ul id="mpagination" class="pagination pagination-sm pagination-dark">
        </ul>
        </nav>
        </center>
        </div>
        <div class="col-lg-4">
        </div>
    </div>

    <div id="progress_bar" class="row mb-3 mt-1">
    </div>
</div>
</div>

    <div class="modal fade" id="scanResModal" tabindex="-1" aria-labelledby="scanResModalLabel" aria-modal="true"
        role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scanResModalLabel">Scan complete</h5>
                    <button type="button" class="close" aria-label="Close" onclick="closeScanSuccessModal()">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div id="scan_success_modal_body" class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeScanSuccessModal()">See scan results</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="configScanModal" tabindex="-1" aria-labelledby="scanResModalLabel" aria-modal="true"
        role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title" id="scanResModalLabel">Configure scan</h1>
                    <button type="button" class="close" aria-label="Close" onclick="closeConfigScanParamsModal()">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div id="config_scan_modal_body" class="modal-body">
                <div id="hdbscanparams"> 
                <div class="row">
                    <div class="col-md-4 mb-1">
                    <span class="badge badge-info">Choose sample to prescan</span><br/>
                </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <label for="cc-expiration">K</label>                        
                    </div>
                    <div class="col-md-6">
                        <label for="cc-expiration">Eps distance</label>                        
                    </div>                                      
                </div>
                <div class="row">
                    <div class="col-md-6 mb-1">                        
                        <input type="text" class="form-control" id="k">
                    </div>
                    <div class="col-md-6 mb-1">                        
                        <input type="text" class="form-control" id="epsdist">
                    </div>                                  
                </div>                
                </div>                          
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="addConfiguration()"> Add sample 
                        <span id="num_confs_set" class="badge badge-info"></span><br/>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeConfigScanParamsModal()"> Save</button>
                </div>
                <div class="modal-footer">
                  
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" id="backdrop" style="display: none;"></div>

    </div>
</div>

<script>


(function () {
    setFolders()
    loadInitialScanParams();
    setExperimentFiles(dir="experimentfiles/", searchKey=null,pageNum=1);
})();

function addConfiguration()
{
  if (typeof addConfiguration.confs == 'undefined') {
    addConfiguration.confs = [];
    addConfiguration.idx = 0;
  }
    var new_conf = []   
    new_conf.push(document.getElementById("k").value);
    new_conf.push(document.getElementById("epsdist").value);


    addConfiguration.idx += 1;
    addConfiguration.confs.push(new_conf);
    var n = addConfiguration.confs.length + 1
    document.getElementById("num_confs_set").innerHTML = "(" + n.toString() + ")";
    loadInitialScanParams();
}
function search() {
    var search_text = document.getElementById("search").value;
    var selected_folder = document.getElementById("folderselect").value;
    if (search_text == "") {
        search_text = null;
    }
    setExperimentFiles(folder=selected_folder, searchKey=search_text, pageNum=1);
}

function setFolders() {
    var http_request = new XMLHttpRequest();
    http_request.onreadystatechange = function() {
        var jsonObj = JSON.parse(http_request.responseText);
            folders_html = "";
        for (f of jsonObj.folders) {
            folders_html+= "<b><option value='" + f + "'>" + f + "</option></b>";
        }

        document.getElementById("folderselect").innerHTML = folders_html
    };

    var get_url = "/folders";

    http_request.open("GET", get_url, true);
    http_request.send();
}

function setExperimentFiles(dir=null, searchKey=null, pageNum=null) {
    var http_request = new XMLHttpRequest();
    http_request.onreadystatechange = function() {
            
    if (http_request.readyState == 4  ) {
        var jsonObj = JSON.parse(http_request.responseText);
        var dir = jsonObj.folder;
        var files = jsonObj.exfiles;
        var num_of_pages = jsonObj.total_files / 10;
        var first_tab_experiment_files = "";
        var second_tab_experiment_files = "";
        var c = 0;
        for (f of files) {
                var fname = f
            if (f.length > 40) {
                fname = f.substring(0,40)
            }
            c += 1;
            if (c > Math.floor(files.length / 2)) {
                first_tab_experiment_files += "<button id=\"" + f + "\" ";
                first_tab_experiment_files += "style=\"text-align:left;\" type=\"button\" class=\"btn btn-secondary btn-xs btn-block\" ";
                first_tab_experiment_files += "onclick=\"addFile('" + dir + "','" + f + "')\">";
                first_tab_experiment_files += "<span style=\"font-size:14px;font-weight:bold;\" class=\"badge badge-info\">";
                first_tab_experiment_files +=  fname + "</span></button>";
            } else {
                second_tab_experiment_files += "<button id=\"" + f + "\" ";
                second_tab_experiment_files += "style=\"text-align:left;\" type=\"button\" class=\"btn btn-secondary btn-xs btn-block\" ";
                second_tab_experiment_files += "onclick=\"addFile('" + dir + "','" + f + "')\">";
                second_tab_experiment_files += "<span style=\"font-size:14px;font-weight:bold;\" class=\"badge badge-info\">";
                second_tab_experiment_files +=  fname + "</span></button>";
            }
        }
        
        document.getElementById("first_files_text").innerHTML = first_tab_experiment_files;
        document.getElementById("second_files_text").innerHTML = second_tab_experiment_files;

        // Handle pagination:
        var searchkey_onclick_text = "null";
        var dir_select = ""
        if (jsonObj.folder != null){
            dir_select = "folder='" + jsonObj.folder +"'"; 
        } else {
            dir_select ="folder='experimentfiles'/"
        }
        if (jsonObj.search_key != null) {
            searchkey_onclick_text = ",searchKey='" + jsonObj.search_key + "'";
        } else {
            searchkey_onclick_text = ",searchKey=null";
        }
        var pages_str = "";
        var num_of_pages = Math.floor(jsonObj.total_files / jsonObj.items_in_page) + 1;

        if (num_of_pages >= 10) {
            // 5 Pages backwards, 
            var num_to_iterate = 5;
            var p = jsonObj.requested_page - num_to_iterate;

            if (p <= 0) {
                num_to_iterate += (p - 1);
                p = 1;
            }

            for (;p <= jsonObj.requested_page - 1; p++) {
                pages_str += "<li class=\"page-item\"><a class=\"page-link\" href=\"#\""; 
                pages_str += "onclick=\"setExperimentFiles(" + dir_select + searchkey_onclick_text
                pages_str  += ",pageNum=" + p.toString() + ")\">";
                pages_str += p.toString();
                pages_str += "</a></li>";
            }

            pages_str += "<li class=\"page-item active\"><a class=\"page-link\" href=\"#\""; 
            pages_str += "onclick=\"setExperimentFiles(" + dir_select + searchkey_onclick_text
            pages_str  += ",pageNum=" + jsonObj.requested_page.toString() + ")\">";
            pages_str += jsonObj.requested_page.toString();
            pages_str += "</a></li>";

            var p = jsonObj.requested_page + 1;

            for(; p <= jsonObj.requested_page + 5 && p <= num_of_pages;p++) {
                pages_str += "<li class=\"page-item\"><a class=\"page-link\" href=\"#\""; 
                pages_str += "onclick=\"setExperimentFiles(" + dir_select + searchkey_onclick_text
                pages_str  += ",pageNum=" + p.toString() + ")\">";
                pages_str += p.toString();
                pages_str += "</a></li>";
            }
        } else {

            for (var p = 1; p <= num_of_pages; p++)
            {
                var is_active = "";
                if (p == jsonObj.requested_page)
                {
                    is_active = "active";
                }

                pages_str += "<li class=\"page-item " + is_active + "\"><a class=\"page-link\" href=\"#\""; 
                pages_str += "onclick=\"setExperimentFiles(" + dir_select + searchkey_onclick_text
                pages_str  += ",pageNum=" + p.toString() + ")\">";
                pages_str += p.toString();
                pages_str += "</a></li>";
            }
        }

        document.getElementById("mpagination").innerHTML = pages_str;

    }
    };
    var get_url = "/exfiles";

    if (pageNum != null && searchKey == null) {
        get_url += "?pagenum=" + pageNum.toString();
    } else if (pageNum == null && searchKey != null) {
        get_url += "?searchkey=" + searchKey;
    } else {
        get_url += "?pagenum=" + pageNum.toString();
        get_url += "&searchkey=" + searchKey;
    }

    if (dir != null){
        get_url += "&folder=" + dir;
    } else {
        get_urk += "&folder=experimentfiles/"
    }

    http_request.open("GET", get_url, true);
    http_request.send();
};

function addFile(dir, fileName) {
    
    if( typeof addFile.files == 'undefined') {
        addFile.files = [];
    }

    file_exists = false;
    for (f of addFile.files) {
        if (f[1] == fileName) {
            file_exists = true;
            alert("File already selected for scan")
            return;
        }
    }

    document.getElementById(fileName).className = "btn btn-dark btn-xs btn-block";

    var f = [[dir, fileName]];

    if (!file_exists) {
        addFile.files = f.concat(addFile.files);
    }

    renderSelectedFilesHTML();
};

function renderSelectedFilesHTML()
{


    var append_str = "";
    var c = 0;

    for (f of addFile.files) {
        append_str += "<li class=\"list-group-item\">" + f[1] + "</li>";

        c += 1;

        if (c > 7) {
            break;
        }
    }
    var is_genThreeD_checked = false;
    if (document.getElementById("genThreeD").checked){
         is_genThreeD_checked = true;   
    }
    document.getElementById("num_of_files_selected").innerHTML = "";

    if (addFile.files.length > 0) {

        document.getElementById("scan_options").style="visibility:visible";
        document.getElementById("num_of_files_selected").innerHTML = "(" + (addFile.files.length).toString() + ")";
    } else {
        document.getElementById("scan_options").style="visibility:hidden";
    }


    document.getElementById("files_selected").innerHTML = append_str;
}

function resetFiles() {

    if( typeof addFile.files != 'undefined') {
        for (f of addFile.files) {
            document.getElementById(f[1]).className = "btn btn-secondary btn-xs btn-block";
        }
        
        addFile.files = [];
    }

    renderSelectedFilesHTML();
};

function runPrescan() {

    var http_request = new XMLHttpRequest();
    http_request.onreadystatechange = function() {        
        if (http_request.readyState == 4  ) {
            pollPrescanResults();
        }

    };

    http_request.open("POST", "/doprescan", true);

    http_request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    var post_payload = "files="

    for (f of addFile.files) {
        post_payload += f[0] + "/" + f[1] + ";"
    }

    k = "&k=" + document.getElementById("k").value + ";";
    epsdist = "&epsdist=" + document.getElementById("epsdist").value + ";";

    if (addConfiguration.confs != undefined) {
        for (conf of addConfiguration.confs) { 

            k += conf[0] + ";"
            epsdist += conf[1] + ";"
        }
    }

    post_payload += k;
    post_payload += epsdist;


    append_str = "<div class=\"btn-group btn-group-sm\" role=\"group\" aria-label=\"First group\">";
    append_str += "<button class=\"btn btn-secondary\" type=\"button\" disabled>";
    append_str += "<span class=\"spinner-border spinner-border-sm\" role=\"status\" aria-hidden=\"true\"></span>";
    append_str += " Prescan running </button>";
    append_str += "<button type=\"button\" class=\"btn btn-secondary\" disabled>Configure sample </button>";
    append_str += "<button type=\"button\" class=\"btn btn-secondary\" disabled>Reset</button>";
    append_str += "</div>"

    document.getElementById("runscan_button").innerHTML = append_str;
    http_request.send(post_payload);
}

function pollPrescanResults (){
    var http_request = new XMLHttpRequest();

    if( typeof pollPrescanResults.not_started_counter == 'undefined' ) {
        pollPrescanResults.not_started_counter = 0;
    }

    if( typeof pollPrescanResults.retries_count == 'undefined' ) {
        pollPrescanResults.retries_count = 0;
    }
    else {
        pollPrescanResults.retries_count += 1
    }
    if (pollPrescanResults.retries_count >= 800) {
        alert("Scan request timed out, try again later\n");
        window.location.href = "/runprescan";
    }
    http_request.onreadystatechange = function() {        
        if (http_request.readyState == 4  ) {
            var jsonObj = JSON.parse(http_request.responseText);

            switch(jsonObj.status) {

                case 1: // SCAN_NOT_STARTED
                    if (pollPrescanResults.not_started_counter == 0) {
                        pollPrescanResults.not_started_counter += 1;
                        setTimeout(pollPrescanResults, 200);
                        updateProgressBar(0);
                    } else {
                        alert("Scan not started!\n");
                        window.location.href = "/runprescan";
                    }

                break; 

                case 2: // SCAN_FINISHED_SUCCESSFULLY
                    updateProgressBar(100);
                    openScanSuccessModal();

                break; 

                case 3: // SCAN_FAILED
                    alert("Scan failed, try again later\n");
                    window.location.href = "/runprescan";

                break; 

                case 4: // SCAN_RUNNING
                    updateProgressBar(jsonObj.percentage);
                    setTimeout(pollPrescanResults, 200);

                break; 

                case 5: // SCAN_GENERATING_PLOTS
                    updateProgressBar(jsonObj.percentage);
                    setTimeout(pollPrescanResults, 200);

                break; 
            }
        }
    };

    http_request.open("GET", "/pollprescan", true);
    http_request.send();
    setTimeout
};

function updateProgressBar(percentage)
{
    append_str = "<div class=\"progress\" style=\"width:100%; height:20px; display:block;\">";
    append_str += "<div class=\"progress-bar progress-bar-striped progress-bar-animated bg-info\" role=\"progressbar\" aria-valuenow=\"";
    append_str += percentage.toString() + "\"  aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width: ";
    append_str += percentage.toString() + "%; height:20px\"></div>";
    append_str += "</div>"
    document.getElementById("progress_bar").innerHTML = append_str;
};

function openScanSuccessModal() {
    var http_request = new XMLHttpRequest();
    http_request.onreadystatechange = function() {        
        if (http_request.readyState == 4  ) {
            document.getElementById("backdrop").style.display = "block";
            document.getElementById("scanResModal").style.display = "block";
            document.getElementById("scanResModal").className += "show";

            var jsonObj = JSON.parse(http_request.responseText);

            if (jsonObj.errors == 2){
                modal_body_str = "<div class=\"alert alert-warning\">";
                modal_body_str += "<strong>Scan has failed completely, please try again</strong> </div>";
            } else {
                if (jsonObj.errors == 0) {
                    modal_body_str = "<div class=\"alert alert-success\">";
                    modal_body_str += "<strong>Scan completed without errors!</strong> These are the files scanned: </div>";
                } else if (jsonObj.errors = 1){
                    modal_body_str = "<div class=\"alert alert-warning\">";
                    modal_body_str += "<strong>Scan has completed with some errors</strong> some files may not have been scanned </div>";
                }

                modal_body_str += "<ul class=\"list-group\">";
                var counter = 0;
                for (f of jsonObj.file_results) {
                    if (f.completed == false) {
                        continue;
                    }

                    modal_body_str += "<li class=\"list-group-item\">" + f.filename + "</li>";

                    counter += 1;
                    if (counter > 8 ) {
                        break;
                    }
                }

                modal_body_str += "</ul>";
            }

            document.getElementById("scan_success_modal_body").innerHTML += modal_body_str;
        }
    };

    http_request.open("GET", "/prescanresults", true);
    http_request.send()
}
function closeScanSuccessModal() {
    document.getElementById("backdrop").style.display = "none";
    document.getElementById("scanResModal").style.display = "none";
    document.getElementById("scanResModal").className += document.getElementById("scanResModal").className.replace("show", "");
    window.location.href = "/resultsforprescan"
}

function openConfigScanParamsModal() {
    document.getElementById("backdrop").style.display = "block";
    document.getElementById("configScanModal").style.display = "block";
    document.getElementById("configScanModal").className += "show";
}

function loadInitialScanParams() {
    var http_request = new XMLHttpRequest();
    http_request.onreadystatechange = function() {        
        if (http_request.readyState == 4  ) {

            var jsonObj = JSON.parse(http_request.responseText);
            

            document.getElementById("k").value = jsonObj.k;
            document.getElementById("epsdist").value = jsonObj.eps;
        }

    };

    http_request.open("GET", "/getdefaultprescanparams", true);
    http_request.send()
};

function closeConfigScanParamsModal() {
    document.getElementById("backdrop").style.display = "none";
    document.getElementById("configScanModal").style.display = "none";
    document.getElementById("configScanModal").className += document.getElementById("configScanModal").className.replace("show", "");
}


// Get the modal
var config_modal = document.getElementById('configScanModal');
var scan_res_modal = document.getElementById('scanResModal')
// When the user clicks anywhere outside of the modal, close it
window.onclick = function (event) {
    if (event.target == config_modal) {
        closeConfigScanParamsModal();
    } else if (event.target == scan_res_modal) {
        closeScanSuccessModal()

    }
}

</script>
</body> 
</html> 